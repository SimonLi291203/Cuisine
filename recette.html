<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Recette</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

<h1 id="titre-recette">Recette</h1>

<div id="recette-details">
  <p><strong>Ingrédients :</strong></p>
  <ul id="ingredients-list"></ul>

  <p><strong>Préparation :</strong></p>
  <ol id="preparation-list"></ol>

  <p><strong>Notes :</strong></p>
  <p id="notes-text"></p>

  <p><strong>Date :</strong> <span id="date-text"></span></p>
</div>

<!-- Formulaire pour modifier -->
<div id="recette-form" style="display:none;">
  <label>Titre</label>
  <input type="text" id="titre">

  <label>Ingrédients (séparés par des virgules)</label>
  <textarea id="ingredients" rows="3"></textarea>

  <label>Préparation (séparée par ligne)</label>
  <textarea id="preparation" rows="5"></textarea>

  <label>Notes</label>
  <textarea id="notes" rows="3"></textarea>

  <button onclick="saveRecette()">Sauvegarder</button>
  <button onclick="cancelEdit()">Annuler</button>
</div>

<button id="edit-btn" style="display:none;" onclick="showEditForm()">Modifier</button>
<button id="delete-btn" style="display:none;" onclick="deleteRecette()">Supprimer</button>
<p><a href="index.html">← Retour à la liste</a></p>

<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
  // Initialisation Firebase
  if (!firebase.apps.length) {
    firebase.initializeApp({
      apiKey: "AIzaSyBWp8UeYOQT2LmmLrbuix2-AFJZT47dd2E",
      authDomain: "recettes-personnelles.firebaseapp.com",
      projectId: "recettes-personnelles",
      storageBucket: "recettes-personnelles.firebasestorage.app",
      messagingSenderId: "323047086323",
      appId: "1:323047086323:web:b9afeb7a6a59a0cce03f86",
      measurementId: "G-C16RTE39L8"
    });
  }
  const db = firebase.firestore();

  const urlParams = new URLSearchParams(window.location.search);
  const id = urlParams.get('id');

  const titreH1 = document.getElementById('titre-recette');
  const ingredientsList = document.getElementById('ingredients-list');
  const preparationList = document.getElementById('preparation-list');
  const notesText = document.getElementById('notes-text');
  const dateText = document.getElementById('date-text');

  const editBtn = document.getElementById('edit-btn');
  const deleteBtn = document.getElementById('delete-btn');
  const formDiv = document.getElementById('recette-form');

  // Form inputs
  const inputTitre = document.getElementById('titre');
  const inputIngredients = document.getElementById('ingredients');
  const inputPreparation = document.getElementById('preparation');
  const inputNotes = document.getElementById('notes');

  // Charger la recette
  function loadRecette() {
    if(!id) return; // Nouvelle recette
    db.collection("recettes").doc(id).get().then(doc => {
      if(doc.exists){
        const data = doc.data();
        titreH1.textContent = data.titre;
        ingredientsList.innerHTML = '';
        data.ingredients.forEach(i => {
          const li = document.createElement('li'); li.textContent = i; ingredientsList.appendChild(li);
        });
        preparationList.innerHTML = '';
        data.preparation.forEach(s => {
          const li = document.createElement('li'); li.textContent = s; preparationList.appendChild(li);
        });
        notesText.textContent = data.notes || '';
        dateText.textContent = data.date || '';
        // Montrer boutons modifier/supprimer
        editBtn.style.display = 'inline-block';
        deleteBtn.style.display = 'inline-block';
      } else {
        alert('Recette introuvable');
      }
    }).catch(err => alert('Erreur : '+err));
  }

  loadRecette();

  // Afficher le formulaire pour modifier
  function showEditForm() {
    formDiv.style.display = 'block';
    // Pré-remplir le formulaire
    inputTitre.value = titreH1.textContent;
    inputIngredients.value = Array.from(ingredientsList.children).map(li => li.textContent).join(', ');
    inputPreparation.value = Array.from(preparationList.children).map(li => li.textContent).join('\n');
    inputNotes.value = notesText.textContent;
    // Cacher les détails
    document.getElementById('recette-details').style.display = 'none';
    editBtn.style.display = 'none';
    deleteBtn.style.display = 'none';
  }

  // Annuler édition
  function cancelEdit() {
    formDiv.style.display = 'none';
    document.getElementById('recette-details').style.display = 'block';
    editBtn.style.display = 'inline-block';
    deleteBtn.style.display = 'inline-block';
  }

  // Sauvegarder recette (ajout ou modification)
  function saveRecette() {
    const data = {
      titre: inputTitre.value,
      ingredients: inputIngredients.value.split(',').map(s => s.trim()),
      preparation: inputPreparation.value.split('\n').map(s => s.trim()),
      notes: inputNotes.value,
      date: new Date().toISOString().split('T')[0]
    };
    if(id){
      db.collection("recettes").doc(id).set(data)
        .then(()=>{ alert('Recette sauvegardée !'); cancelEdit(); loadRecette(); })
        .catch(err=>alert('Erreur : '+err));
    } else {
      db.collection("recettes").add(data)
        .then(()=>{ alert('Recette sauvegardée !'); window.location.href='index.html'; })
        .catch(err=>alert('Erreur : '+err));
    }
  }

  // Supprimer recette
  function deleteRecette() {
    if(!confirm('Supprimer cette recette ?')) return;
    db.collection("recettes").doc(id).delete()
      .then(()=>{ alert('Recette supprimée !'); window.location.href='index.html'; })
      .catch(err=>alert('Erreur : '+err));
  }
</script>

</body>
</html>
