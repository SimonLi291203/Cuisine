<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Recette</title>
  <link rel="stylesheet" href="style.css">
</head>

<body>

<h1 id="page-title">Recette</h1>

<!-- ===== AFFICHAGE RECETTE ===== -->
<div id="recette-details" style="display:none;">
  <p><strong>IngrÃ©dients :</strong></p>
  <ul id="ingredients-list"></ul>

  <p><strong>PrÃ©paration :</strong></p>
  <ol id="preparation-list"></ol>

  <p><strong>Notes :</strong></p>
  <p id="notes-text"></p>

  <p><strong>Date :</strong> <span id="date-text"></span></p>

  <button onclick="showEditForm()">âœï¸ Modifier</button>
  <button onclick="deleteRecette()">ğŸ—‘ï¸ Supprimer</button>
</div>

<!-- ===== FORMULAIRE ===== -->
<div id="recette-form" style="display:none;">
  <label>Titre</label>
  <input type="text" id="titre">

  <label>IngrÃ©dients (sÃ©parÃ©s par des virgules)</label>
  <textarea id="ingredients" rows="3"></textarea>

  <label>PrÃ©paration (une Ã©tape par ligne)</label>
  <textarea id="preparation" rows="5"></textarea>

  <label>Notes</label>
  <textarea id="notes" rows="3"></textarea>

  <button onclick="saveRecette()">ğŸ’¾ Sauvegarder</button>
  <button onclick="cancelEdit()">âŒ Annuler</button>
</div>

<p><a href="index.html">â† Retour Ã  la liste</a></p>

<!-- ===== FIREBASE ===== -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
/* ================= FIREBASE INIT ================= */
if (!firebase.apps.length) {
  firebase.initializeApp({
    apiKey: "AIzaSyBWp8UeYOQT2LmmLrbuix2-AFJZT47dd2E",
    authDomain: "recettes-personnelles.firebaseapp.com",
    projectId: "recettes-personnelles",
    storageBucket: "recettes-personnelles.firebasestorage.app",
    messagingSenderId: "323047086323",
    appId: "1:323047086323:web:b9afeb7a6a59a0cce03f86",
    measurementId: "G-C16RTE39L8"
  });
}
const db = firebase.firestore();

/* ================= VARIABLES ================= */
const params = new URLSearchParams(window.location.search);
const id = params.get("id");

const details = document.getElementById("recette-details");
const form = document.getElementById("recette-form");
const title = document.getElementById("page-title");

const inputTitre = document.getElementById("titre");
const inputIngredients = document.getElementById("ingredients");
const inputPreparation = document.getElementById("preparation");
const inputNotes = document.getElementById("notes");

/* ================= MODE ================= */

// ğŸ”¹ MODE CRÃ‰ATION
if (!id) {
  title.textContent = "Nouvelle recette";
  form.style.display = "block";
}

// ğŸ”¹ MODE LECTURE
if (id) {
  loadRecette();
}

/* ================= FONCTIONS ================= */

function loadRecette() {
  db.collection("recettes").doc(id).get().then(doc => {
    if (!doc.exists) {
      alert("Recette introuvable");
      window.location.href = "index.html";
      return;
    }

    const data = doc.data();
    title.textContent = data.titre;

    document.getElementById("ingredients-list").innerHTML =
      data.ingredients.map(i => `<li>${i}</li>`).join("");

    document.getElementById("preparation-list").innerHTML =
      data.preparation.map(p => `<li>${p}</li>`).join("");

    document.getElementById("notes-text").textContent = data.notes || "";
    document.getElementById("date-text").textContent = data.date || "";

    details.style.display = "block";
  });
}

function showEditForm() {
  form.style.display = "block";
  details.style.display = "none";

  inputTitre.value = title.textContent;
  inputIngredients.value = [...document.querySelectorAll("#ingredients-list li")]
    .map(li => li.textContent).join(", ");
  inputPreparation.value = [...document.querySelectorAll("#preparation-list li")]
    .map(li => li.textContent).join("\n");
  inputNotes.value = document.getElementById("notes-text").textContent;
}

function cancelEdit() {
  if (id) {
    form.style.display = "none";
    details.style.display = "block";
  } else {
    window.location.href = "index.html";
  }
}

function saveRecette() {
  const today = new Date();
  const day = String(today.getDate()).padStart(2, '0');
  const month = String(today.getMonth() + 1).padStart(2, '0'); // mois de 0 Ã  11
  const year = today.getFullYear();

  const dateEurope = `${day}-${month}-${year}`; // "05-01-2026"

  const data = {
    titre: inputTitre.value,
    ingredients: inputIngredients.value.split(",").map(s => s.trim()),
    preparation: inputPreparation.value.split("\n").map(s => s.trim()),
    notes: inputNotes.value,
    date: dateEurope
  };

  if (id) {
    db.collection("recettes").doc(id).set(data)
      .then(() => {
        alert("Recette modifiÃ©e !");
        location.reload();
      });
  } else {
    db.collection("recettes").add(data)
      .then(() => {
        alert("Recette ajoutÃ©e !");
        window.location.href = "index.html";
      });
  }
}

function deleteRecette() {
  if (!confirm("Supprimer cette recette ?")) return;
  db.collection("recettes").doc(id).delete()
    .then(() => {
      alert("Recette supprimÃ©e");
      window.location.href = "index.html";
    });
}
</script>

</body>
</html>
