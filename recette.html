<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Recette</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

<h1 id="page-title">Recette</h1>

<!-- ================= AFFICHAGE ================= -->
<div id="recette-details" style="display:none;">

  <label><strong>Nombre de personnes :</strong></label>
  <input type="number" id="personnes-affichage" min="1">

  <p><strong>IngrÃ©dients :</strong></p>
  <ul id="ingredients-list"></ul>

  <p><strong>PrÃ©paration :</strong></p>
  <ol id="preparation-list"></ol>

  <p><strong>Notes :</strong></p>
  <p id="notes-text"></p>

  <p><strong>Date :</strong> <span id="date-text"></span></p>

  <button onclick="showEditForm()">âœï¸ Modifier</button>
  <button onclick="deleteRecette()">ğŸ—‘ï¸ Supprimer</button>
</div>

<!-- ================= FORMULAIRE ================= -->
<div id="recette-form" style="display:none;">

  <label>Titre</label>
  <input type="text" id="titre">

  <label>Recette pour combien de personnes ?</label>
  <input type="number" id="personnes" min="1" value="1">

  <label>IngrÃ©dients (1 par ligne : `200 g Farine`)</label>
  <textarea id="ingredients" rows="5"></textarea>

  <label>PrÃ©paration (1 Ã©tape par ligne)</label>
  <textarea id="preparation" rows="5"></textarea>

  <label>Notes</label>
  <textarea id="notes" rows="3"></textarea>

  <button onclick="saveRecette()">ğŸ’¾ Sauvegarder</button>
  <button onclick="cancelEdit()">âŒ Annuler</button>
</div>

<p><a href="index.html">â† Retour Ã  la liste</a></p>

<!-- ================= FIREBASE ================= -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
/* ========= FIREBASE INIT ========= */
if (!firebase.apps.length) {
  firebase.initializeApp({
    apiKey: "AIzaSyBWp8UeYOQT2LmmLrbuix2-AFJZT47dd2E",
    authDomain: "recettes-personnelles.firebaseapp.com",
    projectId: "recettes-personnelles",
    storageBucket: "recettes-personnelles.firebasestorage.app",
    messagingSenderId: "323047086323",
    appId: "1:323047086323:web:b9afeb7a6a59a0cce03f86",
    measurementId: "G-C16RTE39L8"
  });
}
const db = firebase.firestore();

/* ========= VARIABLES ========= */
const params = new URLSearchParams(window.location.search);
const id = params.get("id");

const details = document.getElementById("recette-details");
const form = document.getElementById("recette-form");
const title = document.getElementById("page-title");

const inputTitre = document.getElementById("titre");
const inputPersonnes = document.getElementById("personnes");
const inputIngredients = document.getElementById("ingredients");
const inputPreparation = document.getElementById("preparation");
const inputNotes = document.getElementById("notes");

let recetteData = null;

/* ========= MODES ========= */
if (!id) {
  title.textContent = "Nouvelle recette";
  form.style.display = "block";
} else {
  loadRecette();
}

/* ========= FONCTIONS ========= */

function parseIngredients(text) {
  return text.split("\n").map(line => {
    const parts = line.trim().split(" ");
    return {
      quantite: parseFloat(parts[0]),
      unite: parts[1],
      nom: parts.slice(2).join(" ")
    };
  });
}

function formatIngredients(ingredients) {
  return ingredients.map(i => `${i.quantite} ${i.unite} ${i.nom}`).join("\n");
}

function loadRecette() {
  db.collection("recettes").doc(id).get().then(doc => {
    if (!doc.exists) {
      alert("Recette introuvable");
      window.location.href = "index.html";
      return;
    }

    recetteData = doc.data();
    title.textContent = recetteData.titre;

    document.getElementById("notes-text").textContent = recetteData.notes || "";
    document.getElementById("date-text").textContent = recetteData.date || "";

    document.getElementById("preparation-list").innerHTML =
      recetteData.preparation.map(p => `<li>${p}</li>`).join("");

    displayIngredients(recetteData);

    details.style.display = "block";
  });
}

function displayIngredients(data) {
  const input = document.getElementById("personnes-affichage");
  const base = data.personnes;

  input.value = base;

  function update() {
    const factor = input.value / base;
    document.getElementById("ingredients-list").innerHTML =
      data.ingredients.map(i => {
        const q = (i.quantite * factor).toFixed(2).replace(".00","");
        return `<li>${q} ${i.unite} ${i.nom}</li>`;
      }).join("");
  }

  input.addEventListener("input", update);
  update();
}

function showEditForm() {
  form.style.display = "block";
  details.style.display = "none";

  inputTitre.value = recetteData.titre;
  inputPersonnes.value = recetteData.personnes;
  inputIngredients.value = formatIngredients(recetteData.ingredients);
  inputPreparation.value = recetteData.preparation.join("\n");
  inputNotes.value = recetteData.notes;
}

function cancelEdit() {
  if (id) {
    form.style.display = "none";
    details.style.display = "block";
  } else {
    window.location.href = "index.html";
  }
}

function saveRecette() {
  const data = {
    titre: inputTitre.value,
    personnes: parseInt(inputPersonnes.value),
    ingredients: parseIngredients(inputIngredients.value),
    preparation: inputPreparation.value.split("\n"),
    notes: inputNotes.value,
    date: new Date().toISOString().split("T")[0]
  };

  if (id) {
    db.collection("recettes").doc(id).set(data)
      .then(() => { alert("Recette modifiÃ©e !"); location.reload(); });
  } else {
    db.collection("recettes").add(data)
      .then(() => { alert("Recette ajoutÃ©e !"); window.location.href = "index.html"; });
  }
}

function deleteRecette() {
  if (!confirm("Supprimer cette recette ?")) return;
  db.collection("recettes").doc(id).delete()
    .then(() => { alert("Recette supprimÃ©e"); window.location.href = "index.html"; });
}
</script>

</body>
</html>
